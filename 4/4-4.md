##データから新たな図を作成する
公開されているデータを可視化するだけでも色々な地図を作ることができますが、それらのデータをGISで少し加工するだけで、またひと味ちがった地図を作成することができます。さらに、それらを組み合わせることでオリジナルの新たなデータを作り出すことも可能です。ここでは、河川、標高、植生のデータをそれぞれGISで加工する方法を紹介し、最後にそれらを組み合わせて「カッパ出没マップ」を作成してみます。

※　OSGeo4Wからインストールしている場合はGRASSもインストールしておいてください。
※　36bit
※　日本語パス、ファイル名はダメ

###河川データから河川からの距離図を作成する
国土数値情報の河川データを加工して「河川からの距離図」を作成してみましょう。

####データをダウンロードする
国土数値情報のページでデータ形式[JPGIS2.1]を選択し、「河川」をクリックします。データの説明が書かれているので「座標系」のところを確認しておきましょう。JGD2000/(B,L)となっているので、世界測地系の緯度経度のデータだということが分かります。B,Lというのは、ドイツ語でBreite、Längeの頭文字で緯度、経度の意味です。ダウンロードしたい地域をチェックして、次へボタンを押してください。ダウンロードしたいファイルにチェックを入れて次へボタンを押すと、アンケート画面が表れるので回答したのちファイルをダウンロードします。ZIPファイルを解凍すると2種類のシェープファイルとxmlファイルが入っていますが、W05-07_03-g_Streamの名のシェープファイルが使用する河川のデータになります。（数字の部分はダウンロードした地域によって異なります）

####投影法を変換する
ダウンロードしたファイルは世界測地系の緯度経度（地理座標系）で作成されているデータだということを確認しましたが、距離を正しく扱うためにメートル単位の投影座標系に変換します。

QGISに河川のシェープファイルを読み込みます。その際に「CRSが設定されていません」とメッセージがでるかもしれませんが、それはダウンローしたファイルの中に投影法などの情報を格納したprjファイルもしくはqrjファイルがないので自動で判別できないためです。そこで、まずprjファイルとqrjファイルを作成します。メニューの「ベクタ」→「データマネジメントツール」→「現在の投影法を定義する」を選択します。〔定義されている空間参照システムの利用〕の【選択】ボタンを押し、開いたウインドウのフィルタの欄に「jgd2000」と入力します。すると世界測地系の投影法がリストアップされるので、その中から地理座標系のEPSG:4612を選択して【OK】ボタンを押します。戻ったウインドウの【OK】ボタンを押すとprjファイルとqrjファイルが作成され正しく投影法が定義されます。

(prjファイルとqrjファイルについて、どこかで説明？)

シェープファイルの投影法が正しく定義できたので、次にそこから投影法を変換したファイルを作成します。QGISに読み込んだ河川レイヤを右クリックして「名前をつけて保存」を選択します。「CRS」の項で変換したい投影法を選択します。【ブラウズ】を押して、先ほどと同じようにフィルタの欄に「jgd2000」と入力します。リストアップされた中からJGD2000/UTM zone 54N（EPSG:3100）を選択します。ここでは投影座標系としてUTMを選択し、岩手県のデータを使用したのでゾーン番号は54を選択しました。UTMのゾーン番号は地域によって異なるのでダウンロードしたデータの場所に従って変更してください。名前をつけて保存」で出力するファイル名を指定して、「形式」が、Esri Shapefileになっているのを確認して【OK】ボタンを押します。これで投影法がUTMに変換された河川データが作成できました。

####ラスタデータに変換する
河川からの距離を計算するために河川のデータをベクタからラスタに変換します。
QGISから新規プロジェクトを開き、UTMに変換した河川のシェープファイルを読み込みます。メニューの「ラスタ」→「変換」→「ラスタ化（ベクタのラスタ化）」を選択します。「出力ファイル」を選択した後、「地図の単位ピクセルでのラスタ解像度」を選択して「水平」「垂直」に10と入力します。そのあと、右下の鉛筆ボタンをクリックすると、テキストボックスが編集できるようになり、その他のオプションを直接指定できるようになります。gdal_rasterize のあとに「 -burn 1 」と入力し、川の部分が1になるように指定します（それ以外の部分は0）。そのまま【OK】ボタンを押すとGeoTIFF形式のラスタデータが作成されます。そのままだと黒一色なので、作成したラスタレイヤを右クリックして「プロパティ」の[スタイル]タブで「バンド表示」の「最大」に1を入力して【OK】ボタンを押すと、河川の部分が白く表示されます。

####(Column)GDALツール

####距離を計算する
 変換した河川のラスタデータから距離を計算します。メニューから「ラスタ」→「解析」→「プロキシミティ（ラスタ距離）」を選択します。出力ファイルを選択して【OK】ボタンを押します。計算に少し時間がかかりますが、しばらくすると河川からの距離の値が入ったラスタデータが作成されます。そのままだと分かりにくいので、色を変更します。作成されたラスタレイヤを右クリックして「プロパティ」を選択し[スタイル]タブを開きます。「バンド表示」の「レンダータイプ」を「単バンド疑似カラー」に変更します。「新規カラーマップを作成」から[Spectral]を選択し「最大」に1000と入力します。【分類】ボタンを押したのち【OK】ボタンを押すと、河川から1000mまでを距離に応じて色分けした「河川からの距離図」が作成されます。
 
 
 
###標高データから日射量図を作成する
基盤地図情報の数値表標高モデルのデータを加工して「日射量図」を作成してみましょう。数値標高モデルのデータからGeoTIFFに変換するまでは前章を参照してください。

####投影法を変換する
前章で作成したGeoTIFF形式の数値標高モデルのデータは緯度経度で作成しましたが、日射量を計算するためにメートル単位の投影座標系に変換します。

QGISにGeoTIFF形式に変換した数値標高モデルのデータを読み込みます。メニューの「ラスタ」→「投影法」→「ワープ（再投影）」を選択します。「ターゲット」にチェックを入れて空間参照システムの一覧からJGD2000/UTM zone 54N（EPSG:3100）を選択し【OK】ボタンを押します。ここでは投影座標系としてUTMを選択し、岩手県のデータを使用したのでゾーン番号は54を選択しました。UTMのゾーン番号は地域によって異なるのでダウンロードしたデータの場所に従って変更してください。
「出力ファイル」を指定して、「リサンプリングメソッド」にチェックを入れて[双線形]を選択します。【OK】ボタンを押すと投影法が変換されたGeoTIFFが作成されます。

####傾斜、斜面方位を計算する
日射量を計算するためには、標高、傾斜、傾斜方位のデータが必要です。そのため、UTMに変換したGeoTIFF形式の標高データから傾斜と傾斜方位のデータを作成します。
QGISから新規プロジェクトを開き、UTMに変換した標高のGeoTIFFファイルを読み込みます。メニューの「ラスタ」→「解析」→「DEM(地形モデル)」を選択します。「モード」を[傾斜]にして「出力ファイル」を指定して【OK】ボタンを押します。これで傾斜のデータが作成できました。

傾斜方位も同様にメニューの「ラスタ」→「解析」→「DEM(地形モデル)」を選択します。「モード」を[傾斜方位]にします。「モードオプション」の[三角法角度を返す]と[平地の値に0を返す]の両方にチェックを入れます。このオプションによって傾斜方位を東0°、北90°、西180°、南270°とし、傾斜のない平坦地が0°となります。「出力ファイル」を指定して【OK】ボタンを押すと傾斜方位のデータが作成されます。

####日射量を計算する
用意した標高、傾斜、傾斜方位のデータを使用して日射量を計算します。日射量はプロセッシングツールからGRASSのr.sunを実行して計算します。

最初に、プロセッシングツールの設定を確認します。QGISのメニューから「プロセッシング」→「オプションと構成」を選択します。「プロバイダ」→「GRASS commands」と展開します。

QGISのメニューから「プロセッシング」→「ツールボックス」にチェックを入れると「プロセッシングツールボックス」が開きます。ツールボックス下部のリストボックスを「Advanced Interface」に変更します。「GRASS commands」→「Rater」→「r.sun」を選択します。「Elevation layer」に作成した標高データを指定します。同様に「Aspect layer」に傾斜方位、「Name of the input slope raster map」に傾斜データを指定します。「No. of day of the year」に172と入力します。これは、1月1日から数えて172日目（夏至のあたり）の日射量を計算するという意味になります。「Output global(total) irradiance/irradiation layer」に出力するファイル名を指定します。このファイルは、直射日射、散乱日射、反射日射を合計した指定した日の総日射量を出力します。それ以外の項目は今回は必要ないので、各項目の下にある「Open output file after running algorithm」のチェックを外しておきます。【RUN】ボタンを押すと計算が始まり、172日目の総日射量のファイル作成されます。そのままだと分かりにくいので、色を変更します。作成されたラスタレイヤを右クリックして「プロパティ」を選択し[スタイル]タブを開きます。「バンド表示」の「レンダータイプ」を「単バンド疑似カラー」に変更します。「最小値/最大値のロード」の[最小／最大]にチェックを入れて【読み込み】ボタンを押します。「新規カラーマップを作成」から[Spectral]を選択し[反転]にチェックを入れて【分類】ボタンを押します。【OK】ボタンを押すと、日射量に応じ色分けされます。



###植生データから畑地の面積割合図を作成する
自然環境情報GISの植生データを加工して「畑地の面積割合図」を作成してみましょう。
####データをダウンロードする
自然環境情報GISのページから「Shapeデータダウンロード」に進みます。今回は、1/25,000スケールで整備されている第6-7回植生調査の結果を利用するので、「植生調査情報提供ホームページへ」をクリックします。地図からダウンロードしたい地域を選択して「GISデータ（シェープファイル）」をクリックします。アンケートに答えたのちファイルをダウンロードします。

なお、植生データのライセンスはdata.go.jpの利用規約に従うので、、、、、

####ラスタデータに変換する

####面積割合を計算する
変換した河川のラスタデータからプロセッシングツールボックスを利用して距離を計算します。メニューから「プロセッシング」→「ツールボックス」にチェックを入れると「プロセッシングツールボックス」が開きます。ツールボックス下部のリストボックスを「Advanced Interface」に変更します。「GRASS commands」→「Rater」→「r.neighbors」を選択します。
###データを組み合わせて新たな図を作成する
この章で作成してきたデータを組み合わせて「カッパ出没マップ」を作成してみましょう。
####ラスタデータを組み合わせる
みなさんご存知のとおりカッパは、河川に生息し、キュウリが好物で、頭の皿の乾燥に弱いという生き物です。これを踏まえ「河川からの距離」「畑地の面積割合」「日射量」のデータを組み合わせてカッパが出没しやすい地域を可視化してみます。
QGISのメニューから【ラスタ】→【ラスタ計算機】を選択します。


####ラスタデータとベクタデータを組み合わせる
####(Column) 統計モデル
